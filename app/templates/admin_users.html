{% extends "base.html" %}
{% block title %}Gestion des utilisateurs{% endblock %}

{% block content %}
<h3 class="mb-4">üë• Gestion des utilisateurs</h3>

<!-- üîç Barre de recherche -->
<form method="get" action="{{ url_for('admin.users') }}" class="mb-3 d-flex" style="max-width: 400px;">
  <input type="text" name="q" value="{{ search_query }}" class="form-control me-2" placeholder="Rechercher un utilisateur...">
  <button class="btn btn-outline-primary">Rechercher</button>
</form>

<!-- ‚ûï Ajout d‚Äôun nouvel utilisateur -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="POST" class="row g-3 align-items-center">
      <div class="col-md-4">
        <input type="text" name="username" class="form-control" placeholder="Nom d‚Äôutilisateur" required>
      </div>
      <div class="col-md-4">
        <input type="password" name="password" class="form-control" placeholder="Mot de passe" required>
      </div>
      <div class="col-md-3">
        <select name="role" class="form-select">
          <option value="member">Membre</option>
          <option value="moderator">Mod√©rateur</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-person-plus"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- üßë‚Äçüíª Tableau des utilisateurs -->
<table class="table table-striped align-middle shadow-sm">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Nom d‚Äôutilisateur</th>
      <th>R√¥le</th>
      <th>Statut</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>{{ u.username }}</td>
      <td>
        {% if u.role == 'admin' %}
          <span class="badge bg-warning text-dark">Admin</span>
        {% elif u.role == 'moderator' %}
          <span class="badge bg-info text-dark">Mod√©rateur</span>
        {% else %}
          <span class="badge bg-secondary">Membre</span>
        {% endif %}
      </td>
      <td>
        {% if u.active %}
          <span class="badge bg-success">Actif</span>
        {% else %}
          <span class="badge bg-danger">Inactif</span>
        {% endif %}
      </td>
      <td class="text-end">
  {% if u.username != 'admin' %}
    <!-- ‚úèÔ∏è Modifier -->
    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="collapse" data-bs-target="#edit{{ u.id }}">
      ‚úèÔ∏è Modifier
    </button>

    <!-- üîº Promotion / r√©trogradation -->
    <a href="{{ url_for('admin.promote_user', user_id=u.id) }}" class="btn btn-sm btn-outline-warning me-1">
      {% if u.role == 'admin' %}‚¨áÔ∏è R√©trograder{% else %}‚¨ÜÔ∏è Promouvoir{% endif %}
    </a>

    <!-- üîÅ Activer / d√©sactiver -->
    <a href="{{ url_for('admin.toggle_user', user_id=u.id) }}" class="btn btn-sm {% if u.active %}btn-outline-danger{% else %}btn-outline-success{% endif %} me-1">
      {% if u.active %}D√©sactiver{% else %}Activer{% endif %}
    </a>

    <!-- üîê R√©initialiser le mot de passe -->
    <form action="{{ url_for('admin.reset_password', user_id=u.id) }}" method="POST" class="d-inline"
          onsubmit="return confirm('R√©initialiser le mot de passe de {{ u.username }} ? Un mot de passe temporaire sera d√©fini.');">
      <button type="submit" class="btn btn-sm btn-outline-info me-1">
        <i class="bi bi-arrow-repeat"></i> R√©initialiser
      </button>
    </form>

    <!-- üóëÔ∏è Supprimer -->
    <form action="{{ url_for('admin.delete_user', user_id=u.id) }}" method="POST" class="d-inline"
          onsubmit="return confirm('Voulez-vous vraiment supprimer {{ u.username }} ? Cette action est irr√©versible.')">
      <button type="submit" class="btn btn-sm btn-outline-danger">
        <i class="bi bi-trash"></i>
      </button>
    </form>
  {% endif %}
</td>
    </tr>

    <!-- üíæ Formulaire d‚Äô√©dition cach√© -->
    <tr class="collapse" id="edit{{ u.id }}">
      <td colspan="5">
        <form method="POST" action="{{ url_for('admin.edit_user', user_id=u.id) }}" class="row g-2 align-items-center">
          <div class="col-md-4">
            <select name="role" class="form-select form-select-sm">
              <option value="member" {% if u.role == 'member' %}selected{% endif %}>Membre</option>
              <option value="moderator" {% if u.role == 'moderator' %}selected{% endif %}>Mod√©rateur</option>
              <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
            </select>
          </div>
          <div class="col-md-4">
            <input type="password" name="password" class="form-control form-control-sm" placeholder="Nouveau mot de passe (optionnel)">
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-sm btn-success" type="submit">
              üíæ Enregistrer
            </button>
          </div>
        </form>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="5" class="text-center text-muted py-3">
        Aucun utilisateur trouv√©.
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- üìÑ Pagination -->
<nav aria-label="Pagination utilisateurs">
  <ul class="pagination justify-content-center mt-4">
    {% if pagination.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('admin.users', page=pagination.prev_num, q=search_query) }}">‚üµ Pr√©c√©dent</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">‚üµ Pr√©c√©dent</span></li>
    {% endif %}

    <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} / {{ pagination.pages }}</span></li>

    {% if pagination.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('admin.users', page=pagination.next_num, q=search_query) }}">Suivant ‚ü∂</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Suivant ‚ü∂</span></li>
    {% endif %}
  </ul>
</nav>

<div class="text-end mt-4">
  <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
    ‚¨ÖÔ∏è Retour au tableau de bord
  </a>
</div>
{% endblock %}
