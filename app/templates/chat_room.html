{% extends "base.html" %}
{% block title %}💬 {{ room.name }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="fw-bold mb-0"><i class="bi bi-chat-dots text-success"></i> Salon : {{ room.name }}</h4>
  <a href="{{ url_for('chat.room_list') }}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left"></i> Retour
  </a>
</div>

<div class="row g-3">
  <!-- 💬 Zone de chat -->
  <div class="col-lg-8">
    <div id="messages" class="border rounded p-3 mb-3 bg-white shadow-sm" 
         style="height:420px; overflow-y:auto; background:#f9fafc;">
      {% for msg in messages %}
        {% set mine = (msg.user_id == current_user.id) %}
        <div class="msg d-flex flex-column {% if mine %}align-items-end{% else %}align-items-start{% endif %}">
          <div class="msg-bubble {{ 'mine' if mine else 'other' }}">
            <div class="small text-muted mb-1">
              {{ 'Moi' if mine else msg.user.username }} – {{ msg.timestamp.strftime('%d/%m/%Y %H:%M') }}
            </div>

            {% if msg.file_path %}
              {% if msg.file_path.endswith('.pdf') %}
                📄 <a href="{{ url_for('static', filename=msg.file_path) }}" target="_blank">Voir le document</a>
              {% else %}
                <img src="{{ url_for('static', filename=msg.file_path) }}" class="img-fluid rounded shadow-sm" style="max-width:200px;">
              {% endif %}
            {% elif msg.content %}
              <div class="msg-text">{{ msg.content }}</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- 📨 Envoi de message texte -->
    <form id="chatForm" class="input-group shadow-sm">
      <input type="text" id="msgInput" class="form-control" placeholder="Écris un message..." autocomplete="off">
      <button class="btn btn-success" type="submit">
        <i class="bi bi-send-fill"></i> Envoyer
      </button>
    </form>

    <!-- 📎 Envoi de fichier (Socket.IO, en direct) -->
    <div class="input-group mt-2 shadow-sm">
      <input type="file" id="fileInput" class="form-control" accept=".pdf,image/*">
      <button type="button" id="fileBtn" class="btn btn-outline-primary">
        <i class="bi bi-paperclip"></i> Envoyer fichier
      </button>
    </div>
  </div>

  <!-- 👥 Liste des membres connectés -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex align-items-center">
        <i class="bi bi-people-fill me-2"></i> Membres connectés
      </div>
      <ul id="user-list" class="list-group list-group-flush small" style="max-height:420px; overflow-y:auto;"></ul>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const roomId = {{ room.id }};
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const form = document.getElementById('chatForm');
const userList = document.getElementById('user-list');

// ✅ Rejoindre le salon
socket.emit("join_room", { room_id: roomId });

// Quitter proprement le salon
window.addEventListener("beforeunload", () => {
  socket.emit("leave_room", { room_id: roomId });
});

// Scroll en bas au chargement
messagesDiv.scrollTop = messagesDiv.scrollHeight;

// === Envoi d’un message texte ===
form.addEventListener('submit', e => {
  e.preventDefault();
  const content = msgInput.value.trim();
  if(content){
    socket.emit('send_message', {content, room_id: roomId});
    msgInput.value = '';
  }
});

// === Réception d’un message texte ===
socket.on('receive_message', data => {
  if(data.room_id !== roomId) return;
  const mine = data.user === "{{ current_user.username }}";
  const wrapper = document.createElement('div');
  wrapper.className = 'msg d-flex flex-column ' + (mine ? 'align-items-end' : 'align-items-start');
  wrapper.innerHTML = `
    <div class="msg-bubble ${mine ? 'mine' : 'other'}">
      <div class="small text-muted mb-1">${mine ? 'Moi' : data.user} – ${data.timestamp}</div>
      <div class="msg-text">${escapeHtml(data.content)}</div>
    </div>`;
  messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// === Envoi d’un fichier via Socket.IO ===
const fileInput = document.getElementById('fileInput');
const fileBtn = document.getElementById('fileBtn');

fileBtn.addEventListener('click', () => {
  const file = fileInput.files[0];
  if (!file) {
    alert("📁 Sélectionne un fichier avant d’envoyer !");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Data = e.target.result.split(',')[1];
    socket.emit('send_file', {
      filename: file.name,
      file_data: base64Data,
      room_id: roomId
    });
  };
  reader.readAsDataURL(file);

  fileInput.value = '';
});

// === Réception d’un fichier en direct ===
socket.on('receive_file', data => {
  if(data.room_id !== roomId) return;

  const mine = data.user === "{{ current_user.username }}";
  const wrapper = document.createElement('div');
  wrapper.className = 'msg d-flex flex-column ' + (mine ? 'align-items-end' : 'align-items-start');

  let fileDisplay = "";
  if(['png', 'jpg', 'jpeg', 'gif'].includes(data.ext)) {
    fileDisplay = `<img src="/static/${data.file_path}" class="img-fluid rounded shadow-sm" style="max-width:200px;">`;
  } else if(data.ext === 'pdf') {
    fileDisplay = `📄 <a href="/static/${data.file_path}" target="_blank">Voir le document</a>`;
  }

  wrapper.innerHTML = `
    <div class="msg-bubble ${mine ? 'mine' : 'other'}">
      <div class="small text-muted mb-1">${mine ? 'Moi' : data.user} – ${data.timestamp}</div>
      ${fileDisplay}
    </div>`;
  messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// === Liste des utilisateurs connectés ===
socket.on("update_user_list", users => {
  userList.innerHTML = "";
  if(users.length === 0){
    userList.innerHTML = `<li class="list-group-item text-muted text-center">Aucun connecté</li>`;
    return;
  }
  users.forEach(u => {
    const li = document.createElement("li");
    li.classList.add("list-group-item", "d-flex", "align-items-center");
    li.innerHTML = `<i class="bi bi-circle-fill text-success me-2" style="font-size:0.6rem;"></i> ${u}`;
    userList.appendChild(li);
  });
});

// === Messages système (connexion/déconnexion) ===
socket.on("system_message", data => {
  const div = document.createElement("div");
  div.classList.add("text-muted", "small", "fst-italic");
  div.textContent = data.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Fonction utilitaire
function escapeHtml(str){
  return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}
</script>

<style>
.msg-bubble {
  max-width: 75%;
  padding: 8px 12px;
  border-radius: 10px;
  margin-bottom: 6px;
  word-wrap: break-word;
}
.msg-bubble.mine {
  background-color: #d1e7dd;
  border: 1px solid #a3cfbb;
  color: #0f5132;
}
.msg-bubble.other {
  background-color: #e9ecef;
  border: 1px solid #d3d6d8;
  color: #212529;
}
.msg-text {
  white-space: pre-wrap;
}
.msg-bubble img {
  margin-top: 4px;
  border-radius: 6px;
}
#msgInput {
  border-radius: 0 6px 6px 0;
}
</style>
{% endblock %}
