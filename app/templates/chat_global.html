{% extends "base.html" %}
{% block content %}
<h4>💬 Salon global</h4>

<div class="row g-3">
  <!-- Colonne messages -->
  <div class="col-lg-9">
    <div id="messages" class="border p-3 mb-3 bg-white" style="height:360px; overflow-y:auto;">
      {% for msg in messages %}
        {% set mine = (msg.user_id == current_user.id) %}
        <div class="msg {{ 'msg-mine' if mine else 'msg-other' }}">
          <div class="msg-header">
            <b>{{ 'Moi' if mine else msg.user.username }}</b>
            <small class="text-muted">{{ msg.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}</small>
          </div>
          <div class="msg-body">{{ msg.content }}</div>
        </div>
      {% endfor %}
    </div>

    <form id="chatForm">
      <div class="input-group">
        <input type="text" id="msgInput" class="form-control" placeholder="Écris un message...">
        <button class="btn btn-success">Envoyer</button>
      </div>
    </form>
  </div>

  <!-- Colonne utilisateurs en ligne -->
  <div class="col-lg-3">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">🟢 En ligne</div>
      <ul id="onlineList" class="list-group list-group-flush" style="max-height:360px; overflow-y:auto;">
        <!-- rempli en temps réel via Socket.IO -->
      </ul>
    </div>
    <div id="systemBox" class="mt-3 small text-muted">
      <!-- messages système -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io();

// Envoi d'un message
document.getElementById('chatForm').addEventListener('submit', function(e){
  e.preventDefault();
  const input = document.getElementById('msgInput');
  const content = input.value.trim();
  if(content !== ''){
    socket.emit('send_message', {content});
    input.value = '';
  }
});

// Réception d'un message : on INSÈRE EN HAUT (plus récent en premier)
socket.on('receive_message', data => {
  const mine = "{{ current_user.id }}" == (data.user_id ? String(data.user_id) : "-1");
  const who = mine ? 'Moi' : data.user;
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (mine ? 'msg-mine' : 'msg-other');
  wrapper.innerHTML = `
    <div class="msg-header">
      <b>${who}</b>
      <small class="text-muted">${data.timestamp}</small>
    </div>
    <div class="msg-body">${escapeHtml(data.content)}</div>
  `;
  const box = document.getElementById('messages');
  box.prepend(wrapper); // ⬅️ insertion en haut
});

// Liste des connectés
socket.on('presence_update', users => {
  const ul = document.getElementById('onlineList');
  ul.innerHTML = '';
  users.forEach(u => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.textContent = u;
    const dot = document.createElement('span');
    dot.className = 'badge bg-success rounded-pill';
    dot.textContent = '●';
    li.appendChild(dot);
    ul.appendChild(li);
  });
});

// Messages système (connexion/déconnexion)
socket.on('system_message', data => {
  const box = document.getElementById('systemBox');
  const p = document.createElement('p');
  p.className = 'mb-1';
  p.textContent = data.text;
  box.prepend(p);
});

// Petite fonction d'échappement pour éviter toute injection HTML
function escapeHtml(str){
  return str
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
</script>
{% endblock %}
